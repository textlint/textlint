{"version":3,"sources":["../../src/engine/textlint-module-loader.js"],"names":["EventEmitter","require","interopRequire","debug","isFile","TextLintModuleLoader","rule","filterRule","processor","error","config","moduleResolver","constructor","rulesBaseDirectory","rulePaths","forEach","rulesDir","rules","Object","keys","entry","ruleName","emit","Event","loadRule","filterRules","loadFilterRule","presets","loadPreset","presetName","plugins","loadPlugin","pluginName","pkgPath","resolvePluginPackageName","plugin","PLUGIN_NAME_PREFIX","prefixMatch","RegExp","pluginNameWithoutPrefix","replace","hasOwnProperty","entities","createEntities","processorEntry","Processor","RULE_NAME_PREFIX","presetRuleNameWithoutPrefix","warn","resolvePresetPackageName","preset","ruleCreator","ruleEntry","definedRuleName","resolveRulePackageName","FILTER_RULE_NAME_PREFIX","resolveFilterRulePackageName"],"mappings":"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","file":"textlint-module-loader.js","sourcesContent":["// LICENSE : MIT\n\"use strict\";\nconst EventEmitter = require(\"events\");\nconst interopRequire = require(\"interop-require\");\nconst debug = require(\"debug\")(\"textlint:module-loader\");\nconst isFile = require(\"is-file\");\nimport {isPluginRuleKey} from \"../util/config-util\";\nimport {loadFromDir} from \"./rule-loader\";\nimport Logger from \"../util/logger\";\nimport TextLintModuleResolver from \"./textlint-module-resolver\";\nimport TextLintModuleMapper from \"./textlint-module-mapper\";\nexport default class TextLintModuleLoader extends EventEmitter {\n    static get Event() {\n        return {\n            rule: \"rule\",\n            filterRule: \"filterRule\",\n            processor: \"preset\",\n            error: \"error\"\n        };\n    }\n\n    constructor(config) {\n        super();\n        /**\n         * @type {Config} config is need for static prefix value\n         */\n        this.config = config;\n        /**\n         * @type {TextLintModuleResolver}\n         */\n        this.moduleResolver = new TextLintModuleResolver(this.config.constructor, this.config.rulesBaseDirectory);\n    }\n\n    /**\n     * set up lint rules using {@lint Config} object.\n     * The {@lint Config} object was created with initialized {@link TextLintEngine} (as-known Constructor).\n     * @param {Config} config the config is parsed object\n     */\n    loadFromConfig(config) {\n        debug(\"config %O\", config);\n        // --ruledir\n        if (config.rulePaths) {\n            // load in additional rules\n            config.rulePaths.forEach(rulesDir => {\n                debug(\"Loading rules from %o\", rulesDir);\n                const rules = loadFromDir(rulesDir);\n                Object.keys(rules).forEach(ruleName => {\n                    const entry = [ruleName, rules[ruleName]];\n                    this.emit(TextLintModuleLoader.Event.rule, entry);\n                });\n            });\n        }\n        // --rule\n        if (config.rules) {\n            // load in additional rules\n            config.rules.forEach(ruleName => {\n                this.loadRule(ruleName);\n            });\n        }\n        // TODO: --filter\n        if (config.filterRules) {\n            // load in additional filterRules\n            config.filterRules.forEach(ruleName => {\n                this.loadFilterRule(ruleName);\n            });\n        }\n        // --preset\n        if (config.presets) {\n            config.presets.forEach(presetName => {\n                this.loadPreset(presetName);\n            });\n        }\n        // --plugin\n        if (config.plugins) {\n            // load in additional rules from plugin\n            config.plugins.forEach(pluginName => {\n                this.loadPlugin(pluginName);\n            });\n        }\n    }\n\n    /**\n     * load rule from plugin name.\n     * plugin module has `rules` object and define rule with plugin prefix.\n     * @param {string} pluginName\n     */\n    loadPlugin(pluginName) {\n        const pkgPath = this.moduleResolver.resolvePluginPackageName(pluginName);\n        debug(\"Loading rules from plugin: %s\", pkgPath);\n        const plugin = interopRequire(pkgPath);\n        const PLUGIN_NAME_PREFIX = this.config.constructor.PLUGIN_NAME_PREFIX;\n        const prefixMatch = new RegExp(\"^\" + PLUGIN_NAME_PREFIX);\n        const pluginNameWithoutPrefix = pluginName.replace(prefixMatch, \"\");\n        // Processor plugin doesn't define rules\n        if (plugin.hasOwnProperty(\"rules\")) {\n            const entities = TextLintModuleMapper.createEntities(plugin.rules, pluginNameWithoutPrefix);\n            entities.forEach(entry => {\n                this.emit(TextLintModuleLoader.Event.rule, entry);\n            });\n        }\n        // register plugin.Processor\n        if (plugin.hasOwnProperty(\"Processor\")) {\n            const processorEntry = [pluginNameWithoutPrefix, plugin.Processor];\n            this.emit(TextLintModuleLoader.Event.processor, processorEntry);\n        }\n    }\n\n    loadPreset(presetName) {\n        /*\n         Caution: Rules of preset are defined as following.\n             {\n                \"rules\": {\n                    \"preset-gizmo\": {\n                        \"ruleA\": false\n\n                }\n            }\n\n        It mean that \"ruleA\" is defined as \"preset-gizmo/ruleA\"\n\n         */\n        const RULE_NAME_PREFIX = this.config.constructor.RULE_NAME_PREFIX;\n        // Strip **rule** prefix\n        // textlint-rule-preset-gizmo -> preset-gizmo\n        const prefixMatch = new RegExp(\"^\" + RULE_NAME_PREFIX);\n        const presetRuleNameWithoutPrefix = presetName.replace(prefixMatch, \"\");\n        // ignore plugin's rule\n        if (isPluginRuleKey(presetRuleNameWithoutPrefix)) {\n            Logger.warn(`${presetRuleNameWithoutPrefix} is Plugin's rule. This is unknown case, please report issue.`);\n            return;\n        }\n\n        const pkgPath = this.moduleResolver.resolvePresetPackageName(presetName);\n        debug(\"Loading rules from preset: %s\", pkgPath);\n        const preset = interopRequire(pkgPath);\n        const entities = TextLintModuleMapper.createEntities(preset.rules, presetRuleNameWithoutPrefix);\n        entities.forEach(entry => {\n            this.emit(TextLintModuleLoader.Event.rule, entry);\n        });\n    }\n\n    /**\n     * load rule file with `ruleName` and define rule.\n     * if rule is not found, then throw ReferenceError.\n     * if already rule is loaded, do not anything.\n     * @param {string} ruleName\n     */\n    loadRule(ruleName) {\n        /*\n           Task\n             - check already define\n             - resolve package name\n             - load package\n             - emit rule\n        */\n        // ruleName is filePath\n        if (isFile(ruleName)) {\n            const ruleCreator = interopRequire(ruleName);\n            const ruleEntry = [ruleName, ruleCreator];\n            this.emit(TextLintModuleLoader.Event.rule, ruleEntry);\n            return;\n        }\n        // ignore already defined rule\n        // ignore rules from rulePaths because avoid ReferenceError is that try to require.\n        const RULE_NAME_PREFIX = this.config.constructor.RULE_NAME_PREFIX;\n        const prefixMatch = new RegExp(\"^\" + RULE_NAME_PREFIX);\n        const definedRuleName = ruleName.replace(prefixMatch, \"\");\n        // ignore plugin's rule\n        if (isPluginRuleKey(definedRuleName)) {\n            Logger.warn(`${definedRuleName} is Plugin's rule. This is unknown case, please report issue.`);\n            return;\n        }\n        const pkgPath = this.moduleResolver.resolveRulePackageName(ruleName);\n        debug(\"Loading rules from %s\", pkgPath);\n        const ruleCreator = interopRequire(pkgPath);\n        const ruleEntry = [definedRuleName, ruleCreator];\n        this.emit(TextLintModuleLoader.Event.rule, ruleEntry);\n    }\n\n    /**\n     * load filter rule file with `ruleName` and define rule.\n     * if rule is not found, then throw ReferenceError.\n     * if already rule is loaded, do not anything.\n     * @param {string} ruleName\n     */\n    loadFilterRule(ruleName) {\n        /*\n           Task\n             - check already define\n             - resolve package name\n             - load package\n             - emit rule\n        */\n        // ignore already defined rule\n        // ignore rules from rulePaths because avoid ReferenceError is that try to require.\n        if (isFile(ruleName)) {\n            const ruleCreator = interopRequire(ruleName);\n            const ruleEntry = [ruleName, ruleCreator];\n            this.emit(TextLintModuleLoader.Event.filterRule, ruleEntry);\n            return;\n        }\n        const RULE_NAME_PREFIX = this.config.constructor.FILTER_RULE_NAME_PREFIX;\n        const prefixMatch = new RegExp(\"^\" + RULE_NAME_PREFIX);\n        const definedRuleName = ruleName.replace(prefixMatch, \"\");\n        // ignore plugin's rule\n        if (isPluginRuleKey(definedRuleName)) {\n            Logger.warn(`${definedRuleName} is Plugin's rule. This is unknown case, please report issue.`);\n            return;\n        }\n        const pkgPath = this.moduleResolver.resolveFilterRulePackageName(ruleName);\n        debug(\"Loading filter rules from %s\", pkgPath);\n        const ruleCreator = interopRequire(pkgPath);\n        const ruleEntry = [definedRuleName, ruleCreator];\n        this.emit(TextLintModuleLoader.Event.filterRule, ruleEntry);\n    }\n}\n\n"]}